name: Backend CI (E2E Checkout)

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  e2e:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # üîß REQUIRED: Go for E2E runner
      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.20"

      # üîß REQUIRED: create .env files from .env.example
      - name: Prepare env files for CI
        run: |
          cp services/product/.env.example services/product/.env
          cp services/cart/.env.example services/cart/.env
          cp services/orders/.env.example services/orders/.env

      # üöÄ Start full stack
      - name: Build and start services
        run: |
          docker compose up -d --build

      # ‚è≥ Wait until all services are ready
      - name: Wait for services to be healthy
        run: |
          echo "Waiting for services..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/healthz \
              && curl -s http://localhost:8081/healthz \
              && curl -s http://localhost:8082/healthz \
              && curl -s http://localhost:8083/healthz; then
              echo "All services are up"
              exit 0
            fi
            sleep 5
          done
          echo "Services failed to start"
          docker compose logs
          exit 1

      # üß™ Full end-to-end checkout test
      - name: Run Full E2E Checkout Flow
        run: |
          go run ./tools/e2e_checkout/full_flow.go

      # ü™µ Debug aid
      - name: Dump logs on failure
        if: failure()
        run: |
          docker compose logs

      # üßπ Always cleanup
      - name: Shutdown services
        if: always()
        run: |
          docker compose down -v
